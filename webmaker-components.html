<!-- our master element for "webmaker" things -->
<element name="webmaker">
  <script>
      (function(global){
        var components = [];
        global.WebMaker = {
          addComponent: function addComponent(c) {
            components.push(c);
          },
          updateComponent: function updateComponent(c) {
            // ...
          },
          getComponentList: function getComponentList() {
            return components;
          }
        };
      }(window));
  </script>
</element>


<!--
  our master element makes sure popcorn gets loaded
-->
<element name="webmaker-popcorn">
  <script>
    // load popcorn if we don't have it available already
    if(!window.Popcorn) {
      var popcorn = document.createElement("script");
      popcorn.src = "http://cdn.popcornjs.org/code/dist/popcorn-complete.js";
      document.head.appendChild(popcorn);
      console.log("added popcorn");
    }
  </script>
</element>


<!--
  The webmaker video component sets up a popcorn'd video
  container
-->
<element name="webmaker-media" attributes="href width height">
  <template>
    <style scoped>
      webmaker-media {
        display: block;
        width: 100%;
      }
      .footnote {
        width: 300px;
        height: 300px;
      }
    </style>
    <div class="webmaker-media">
      <div class="media-container"></div>
      <div id="footnote" class="footnote"></div>
    </div>
  </template>

  <script>
    var getNextCount = (function() {
      var webmakerVideoElementCount = 0;
      return function() {
        return webmakerVideoElementCount++;
      };
    }());

    var template = this.querySelector("element[name='webmaker-media'] template");
    this.register({
      prototype: {
        readyCallback: function() {
          var element = this;
          var w = this.attributes.getNamedItem("width");
          w = w ? w.nodeValue : false;
          var h = this.attributes.getNamedItem("height");
          h = h ? h.nodeValue : false;

          // do template replacing
          var ocontent = this.textContent;
          var ihtml = template.innerHTML;
          var newContent = ihtml.replace("<content></content>",ocontent);
          this.innerHTML = newContent;

          var id = getNextCount();
          var videoElement = this.querySelector(".media-container");
          videoElement.id = "webmakerVideo" + id;
          if(w) { videoElement.width = w|0; videoElement.style.width = w; }
          if(h) { videoElement.height = h|0; videoElement.style.height = h; }

          var footnote = this.querySelector("#footnote");
          footnote.id = footnote.id + id;

          // register with popcorn, once available
          var registerMe = (function(containerId, url) {
            return function() {
              var pop = Popcorn.smart(containerId, url);
              pop.footnoteId = footnote.id;
              pop.play();
              window.pop = pop;
            }
          }("#" + videoElement.id, this.attributes.getNamedItem("href").nodeValue));

          (function tryPopcorn() {
            if(window.Popcorn) { Popcorn(registerMe); }
            else { setTimeout(tryPopcorn, 500); }
          }());

          // register with the WebMaker controller
          WebMaker.addComponent(this);
        }
      }
    });
  </script>
</element>


<!--
  text pop event.
-->
<element name="webmaker-text" attributes="start end">
  <template>
    <style scoped>
      webmaker-text { display: none; }
    </style>
    <p><content></content></p>
  </template>
  <script>
    var template = this.querySelector("template");
    this.register({
      prototype: {
        readyCallback: function() {
          var text = this.textContent;

          if(document.querySelectorAll("webmaker-media").length > 0) {
            var start = this.attributes.getNamedItem("start").nodeValue;
            var end = this.attributes.getNamedItem("end").nodeValue;

            // do template replacing
            this.innerHTML = "";

            // register a text pop event
            var addEvent = function() {
              window.pop.footnote({
                start: start,
                end: end,
                text: text,
                fontSize: 20,
                target: window.pop.footnoteId
              });
            };

            (function tryPopcorn() {
              if(window.pop) { addEvent(); }
              else { setTimeout(tryPopcorn, 500); }
            }());
          }
          else {
            this.style.display = "block";
          }

          // register with the WebMaker controller
          WebMaker.addComponent(this);
        }
      }
    });
  </script>
</element>


<!--
  flickr
-->
<element name="webmaker-image" attributes="start end src alt">
  <template>
    <img src="">
  </template>
  <script>
    var template = this.querySelector("template");
    this.register({
      prototype: {
        readyCallback: function() {
          var src = this.attributes.getNamedItem("src").nodeValue;
          var alt = this.attributes.getNamedItem("alt").nodeValue;
          this.innerHTML = template.innerHTML;
          if(document.querySelectorAll("webmaker-media").length > 0) {
            var start = this.attributes.getNamedItem("start").nodeValue;
            var end = this.attributes.getNamedItem("end").nodeValue;

            // register an image event
            var addEvent = function() {
              var props = {
                start: start,
                end: end,
                src: src,
                alt: alt,
                target: window.pop.footnoteId
              };
              console.log(props);
              window.pop.image(props);
            };

            (function tryPopcorn() {
              if(window.pop) { addEvent(); }
              else { setTimeout(tryPopcorn, 500); }
            }());
          }
          else {
            this.querySelector("img").src = src;
            this.querySelector("img").alt = alt;
          }

          // register with the WebMaker controller
          WebMaker.addComponent(this);
        }
      }
    });
  </script>
</element>


<!--
  google map
-->
<element name="webmaker-map" attributes="start end location">
  <template>
    <style scoped>
      webmaker-map { display: none; }
    </style>
    <content></content>
  </template>
  <script>
    var template = this.querySelector("template");
    this.register({
      prototype: {
        readyCallback: function() {
          var location = this.attributes.getNamedItem("location").nodeValue;

          // use as popcorn plugin?
          if(document.querySelectorAll("webmaker-media").length > 0) {
            var start = this.attributes.getNamedItem("start").nodeValue;
            var end = this.attributes.getNamedItem("end").nodeValue;

            this.innerHTML = "";

            // register a text pop event
            var addEvent = function() {
              window.pop.googlemap({
                start: start,
                end: end,
                location: location,
                zoom: 20,
                target: window.pop.footnoteId
              });
            };

            (function tryPopcorn() {
              if(window.pop) { addEvent(); }
              else { setTimeout(tryPopcorn, 500); }
            }());
          }
          // no popcorn: build iframe instead
          else
          {
            this.innerHTML = '' +
            '<iframe class="webmaker-map" width="425" height="350" frameborder="1" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.ca/maps?f=q&source=s_q&hl=en&geocode=&q=' + location.replace(/ /g,'+') + '&t=m&output=embed"></iframe>';
          }

          // register with the WebMaker controller
          WebMaker.addComponent(this);
        }
      }
    });
  </script>
</element>


<!--
  Wikipedia page-show event
-->
<element name="webmaker-wiki" attributes="start end">
  <template>
    <style scoped>
      webmaker-wiki { display: block; }
    </style>
    <content></content>
  </template>
  <script>
    var template = this.querySelector("template");
    this.register({
      prototype: {
        readyCallback: function() {
          var url = this.attributes.getNamedItem("src").nodeValue;

          var iframe = '' +
            '<iframe class="webmaker-wiki" width="425" height="350" frameborder="1" scrolling="yes" marginheight="0" marginwidth="0" src="'+url+'?&printable=yes"></iframe>';

          if(document.querySelectorAll("webmaker-media").length > 0) {
            var start = this.attributes.getNamedItem("start").nodeValue;
            var end = this.attributes.getNamedItem("end").nodeValue;

            // do template replacing
            this.innerHTML = "";

            // register a text pop event
            var addEvent = function() {
              window.pop.footnote({
                start: start,
                end: end,
                text: iframe,
                title: "this is an article",
                target: window.pop.footnoteId
              });
            };

            (function tryPopcorn() {
              if(window.pop) { addEvent(); }
              else { setTimeout(tryPopcorn, 500); }
            }());
          }

          else {
            this.innerHTML = iframe;
            this.style.display = "block";
            this.style.height = "350px";
          }

          // register with the WebMaker controller
          WebMaker.addComponent(this);
        }
      }
    });
  </script>
</element>


<element name="webmaker-badge-list">
  <template>
    <div id="bhwidget">
      <content></content>
    </div>
  </template>
  <script>
    var script = document.createElement("script");
    script.src = "http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js";
    document.head.appendChild(script);

    var template = this.querySelector("template");
    this.register({
      prototype: {
        readyCallback: function() {
          this.innerHTML = template.innerHTML;
          // register with the WebMaker controller
          WebMaker.addComponent(this);
        }
      }
    });

    var runCode = function() {
      var url = "http://beta.openbadges.org/displayer/5797/group/1957.json";
      jQuery.getJSON(url, function(data) {
        var i = 0;
        var widgetcode = "<table>";
        while (i < data.badges.length < 4) {
          var badgeName = data.badges[i].assertion.badge.name;
          var imgUrl = data.badges[i].assertion.badge.image;
          var critUrl = data.badges[i].assertion.badge.criteria;
          var assertUrl = data.badges[i].hostedUrl;
          widgetcode = widgetcode + "<tr><td align='center'>";
          widgetcode = widgetcode + "<a href='" + assertUrl + "'><img src='" + imgUrl + "' width='50' height='50' border='0'/></a><br /><a href='" + critUrl + "'>" + badgeName + "</a>";
          widgetcode = widgetcode + "</td></tr>";
          i += 1;
          if (i === data.badges.length || i === 3) {
            widgetcode = widgetcode + "</table>";
            document.getElementById("bhwidget").innerHTML = widgetcode;
            return;
          }
        }
      });
    };

    (function tryBadgeList() {
      if(window.jQuery) { runCode(); }
      else { setTimeout(tryBadgeList, 500); }
    }());
  </script>
</element>


